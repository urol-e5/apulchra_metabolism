---
title: "Analyzing logger data"
author: "Ariana S Huffmyer"
date: "10/10/2022"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

This script reads and plots logger environmental data from Hobo pendant loggers in the E5 *A. pulchra* metabolism experiment.  

# Set Up    

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(stringr)
library(readxl)
library(purrr)
library(lubridate)
library(ggplot2)
```

# Read in files  

Read in Hobo Pendant files  
```{r}
pendant.files <- list.files(path="data/environmental/loggers/E5_tanks", pattern="*.xlsx", full.names=TRUE)

pendants <- setNames(pendant.files, pendant.files) %>%
   map_dfr(read_excel, .id = "logger") %>%
   rename(DateTime=`Date-Time (French Polynesia Standard Time)`, temp.C=`Ch: 1 - Temperature   (Â°C )`, light.lux=`Ch: 2 - Light   (lux)`)%>%
  select(!`#`)%>%
  mutate(logger=sub(".*/", "", logger))%>% #remove the path name
  mutate(logger=sub("_.*", "", logger)) #keep only the serial number 

#adjust time to correct values and force time zone
pendants$DateTime <- force_tz(pendants$DateTime, tzone = "Pacific/Tahiti")
```

# Read in treatment information  

Read in metadata that assigns a pendant serial number to a tank number and/or treatment.  
```{r}
metadata<-read_csv("data/environmental/loggers/E5_tanks/logger_metadata.csv")
metadata$logger<-as.character(metadata$logger)
```

Assign treatment information to logger data.  
```{r}
pendants<-left_join(pendants, metadata, by="logger")
pendants$tank<-as.factor(pendants$tank)
```

# Apply tempreature calibrations  

Read in calibration output file with the intercept and coefficients for calibration.  
```{r}
temp_cal<-read_csv("output/environmental/temperature_logger_calibrations.csv")
temp_cal$logger<-as.character(temp_cal$logger)
```

Generate a calibrated temperature column in our logger dataframe.  
```{r}
pendants<-left_join(pendants, temp_cal, by="logger")

pendants<-pendants%>%
  mutate(temp.calibrated=temp.C*coef+intercept)%>%
  select(!coef)%>%
  select(!intercept)
```

# Apply light calibrations  

Read in calibration output file with the intercept and coefficients for calibration.  
```{r}
light_cal<-read_csv("output/environmental/light_logger_calibrations.csv")
light_cal$logger<-as.character(light_cal$logger)
```

Generate a calibrated light column in our logger dataframe.  
```{r}
pendants<-left_join(pendants, light_cal, by="logger")

pendants<-pendants%>%
  mutate(PAR.calibrated=light.lux*coef+intercept)%>%
  select(!coef)%>%
  select(!intercept)
```

# Plot temperature    

Plot over time by tank  
```{r}
temp_plot<-pendants%>%
  filter(DateTime > '2022-09-26 11:20:00')%>% 
  
  ggplot(aes(x=DateTime, y=temp.calibrated, colour=tank))+
  geom_line()+
  theme_classic(); temp_plot
```

Tanks 1, 2, and 3 have been experiencing a spike in temperature in the morning hours. This is due to the way the sun hits the tanks in the morning from the side. We can address this by shuffling the thanks so that all tanks experience similar conditions throughout the experiment. Alternatively, we can move the experiment to a different water table section.  

# Plot light     

Plot over time by tank  
```{r}
light_plot<-pendants%>%
  ggplot(aes(x=DateTime, y=PAR.calibrated, colour=tank))+
  geom_line()+
  theme_classic(); light_plot
```

Tanks 1, 2, and 3 have been experiencing a spike in light in the morning hours. This is due to the way the sun hits the tanks in the morning from the side. We can address this by shuffling the thanks so that all tanks experience similar conditions throughout the experiment. Alternatively, we can move the experiment to a different water table section.  

We need to revisit the light logger calibration. PAR values are higher than expected from the daily measurements.  